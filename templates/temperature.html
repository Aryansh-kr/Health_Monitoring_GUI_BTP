<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üå°Ô∏è Temperature Monitoring</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background: #111;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
    }
    .card {
      background: #222;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0px 0px 10px rgba(79, 195, 247, 0.3);
      transition: transform 0.2s ease-in-out;
    }
    .card:hover { transform: scale(1.05); }
    .title { color: #4fc3f7; margin-bottom: 20px; }
    canvas {
      background: #1a1a1a;
      border-radius: 8px;
      margin-top: 20px;
      padding: 10px;
    }
    .status-normal { color: #2ecc71; font-weight: bold; }
    .status-warning { color: #ff5252; font-weight: bold; }

    /* ‚úÖ Fix: status panel separated */
    .status-panel {
      margin-top: 20px;
      padding: 10px;
      border-radius: 8px;
      background: #1a1a1a;
      box-shadow: 0px 0px 10px rgba(0, 200, 255, 0.3);
    }
  </style>
</head>
<body>
<div class="container py-4">
  <h2 class="title">üå°Ô∏è Temperature Monitoring Dashboard</h2>

  <!-- Cards row -->
  <div class="row" id="sensor-cards"></div>

  <!-- Chart -->
  <div class="mt-4">
    <canvas id="tempChart" height="120"></canvas>
  </div>

  <!-- ‚úÖ Status Panel -->
  <div class="status-panel mt-3">
    <p id="statusText">‚úÖ System ready</p>
    <p id="lastUpdate">Last update: --:--:--</p>
  </div>
</div>

<script>
const cardConfigs = [
  { name: "Contact Temperature", unit: "¬∞C" },
  { name: "Ambient Temperature", unit: "¬∞C" },
  { name: "Core Body Temperature", unit: "¬∞C" }
];

// Inject cards dynamically
const cardContainer = document.getElementById("sensor-cards");
cardConfigs.forEach((cfg, i) => {
  cardContainer.innerHTML += `
    <div class="col-md-4">
      <div class="card">
        <h5>${cfg.name}</h5>
        <h2 id="value-${i}">--</h2><span>${cfg.unit}</span>
        <p id="status-${i}" class="status-normal">‚óè Normal</p>
        <p id="min-${i}">Min: --</p>
        <p id="max-${i}">Max: --</p>
        <p id="avg-${i}">Avg: --</p>
      </div>
    </div>
  `;
});

// Chart.js setup
const ctx = document.getElementById("tempChart").getContext("2d");
const tempChart = new Chart(ctx, {
  type: "line",
  data: {
    labels: [],
    datasets: cardConfigs.map((cfg, i) => ({
      label: cfg.name,
      data: [],
      borderColor: ["#4fc3f7", "#00bcd4", "#ff5252"][i],
      borderWidth: 2,
      tension: 0.3,
      fill: false
    }))
  },
  options: {
    responsive: true,
    animation: false,
    plugins: {
      legend: { labels: { color: "white" } }
    },
    scales: {
      x: { ticks: { color: "white" } },
      y: { ticks: { color: "white" } }
    }
  }
});

// Fetch & update loop
async function fetchData() {
  try {
    const res = await fetch("/api/temp-data");
    const data = await res.json();

    document.getElementById("lastUpdate").innerText = "Last update: " + data.timestamp;

    data.temperatures.forEach((temp, i) => {
      document.getElementById("value-" + i).innerText = temp;
      document.getElementById("min-" + i).innerText = "Min: " + data.stats[i].min;
      document.getElementById("max-" + i).innerText = "Max: " + data.stats[i].max;
      document.getElementById("avg-" + i).innerText = "Avg: " + data.stats[i].avg;

      const statusEl = document.getElementById("status-" + i);
      if (data.statuses[i] === "warning" || data.statuses[i] === "critical") {
        statusEl.className = "status-warning";
        statusEl.innerText = "‚óè " + data.statuses[i].toUpperCase();
        document.getElementById("statusText").innerText = "‚ö† Warning detected!";
      } else {
        statusEl.className = "status-normal";
        statusEl.innerText = "‚óè Normal";
        document.getElementById("statusText").innerText = "‚úÖ System ready";
      }
    });

    // Update chart
    tempChart.data.labels.push(data.timestamp);
    data.temperatures.forEach((t, i) => {
      tempChart.data.datasets[i].data.push(t);
    });
    if (tempChart.data.labels.length > 50) {
      tempChart.data.labels.shift();
      tempChart.data.datasets.forEach(ds => ds.data.shift());
    }
    tempChart.update("none");
  } catch (err) {
    console.error("Error fetching temperature data:", err);
  }
}

setInterval(fetchData, 1000);
</script>
</body>
</html>
